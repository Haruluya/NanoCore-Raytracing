import{d as T,n as V,r as E,u as v,_ as $,o as z,c as W,a as q}from"./index.a6c34d63.js";import{r as A,d as L}from"./RenderUtils.1dc0c613.js";import{v as I,a as _,g as m,e as h,f as N,b as j}from"./Vectors.edfcf4f8.js";class P{constructor(t,i){this.m_origin=t,this.m_direction=i}get origin(){return this.m_origin}get direction(){return this.m_direction}setDirection(t){this.m_direction=t}setOrigin(t){this.m_origin=t}at(t){return I(this.m_origin,_(this.m_direction,t))}}class X{constructor(t,i,l,e){this.p=t,this.normal=i,this.t=l,this.front_face=e}set_face_normal(t,i){front_face=m(t.direction,i)<0,normal=front_face?i:-i}}class M{hit(t,i,l,e){}}class Y extends M{constructor(t){super(),this.objects=t}add(t){this.objects.push(t)}clear(){this.objects=[]}hit(t,i,l,e){let o=!1,n=l;return this.objects.forEach(a=>{a.hit(t,i,n,e)&&(o=!0,n=e.t)}),o}}class O extends M{constructor(t,i){super(),this.center=t,this.radius=i}hit(t,i,l,e){let o=h(t.origin,this.center),n=N(t.direction),a=m(o,t.direction),g=N(o)-this.radius*this.radius,u=a*a-n*g;if(u>0){let c=Math.sqrt(u),s=(-a-c)/n;if(s<l&&s>i)return e.t=s,e.p=t.at(e.t),e.normal=_(h(e.p,this.center),1/this.radius),!0;if(s=(-a+c)/n,s<l&&s>i)return e.t=s,e.p=t.at(e.t),e.normal=_(h(e.p,this.center),1/this.radius),!0}return!1}}class Z extends M{constructor(t,i){super(),this.min=t,this.max=i}hit(t,i,l,e){let o,n,a=1/t.direction[0],g=1/t.direction[1],u=1/t.direction[2],c=(this.min[0]-t.origin[0])*a,s=(this.max[0]-t.origin[0])*a;if(o=Math.min(c,s),n=Math.max(c,s),c=(this.min[1]-t.origin[1])*g,s=(this.max[1]-t.origin[1])*g,o=Math.max(o,Math.min(c,s)),n=Math.min(n,Math.max(c,s)),c=(this.min[2]-t.origin[2])*u,s=(this.max[2]-t.origin[2])*u,o=Math.max(o,Math.min(c,s)),n=Math.min(n,Math.max(c,s)),n<o)return!1;if(o>i&&n<l)e.t=o;else if(n>i&&n<l)e.t=n;else return!1;e.p=[t.origin[0]+e.t*t.direction[0],t.origin[1]+e.t*t.direction[1],t.origin[2]+e.t*t.direction[2]];let d=[0,0,0];return e.p[0]<this.min[0]+1e-4?d[0]=-1:e.p[0]>this.max[0]-1e-4&&(d[0]=1),e.p[1]<this.min[1]+1e-4?d[1]=-1:e.p[1]>this.max[1]-1e-4&&(d[1]=1),e.p[2]<this.min[2]+1e-4?d[2]=-1:e.p[2]>this.max[2]-1e-4&&(d[2]=1),e.normal=d,!0}}class F extends M{constructor(t,i,l){super(),this.center=t,this.radius=i,this.height=l}hit(t,i,l,e){const o=h(t.origin,this.center),n=N(t.direction)-Math.pow(m(t.direction,this.axis()),2),a=m(o,t.direction)-m(o,this.axis())*m(t.direction,this.axis()),g=N(o)-Math.pow(m(o,this.axis()),2)-Math.pow(this.radius,2),u=Math.pow(a,2)-n*g;if(u>0){let c=Math.sqrt(u),s=(-a-c)/n;if(s<l&&s>i&&this.isWithinBounds(s,t)){e.t=s,e.p=t.at(e.t);const d=j(h(h(e.p,this.center),_(this.axis(),m(h(e.p,this.center),this.axis()))));return e.normal=d,!0}if(s=(-a+c)/n,s<l&&s>i&&this.isWithinBounds(s,t)){e.t=s,e.p=t.at(e.t);const d=j(h(h(e.p,this.center),_(this.axis(),m(h(e.p,this.center),this.axis()))));return e.normal=d,!0}}return!1}axis(){return[0,1,0]}isWithinBounds(t,i){const l=i.origin[1]+t*i.direction[1];return l>=this.center[1]&&l<=this.center[1]+this.height}}const G={category:"Raytracing",name:"Normal",buttonContent:"\u67E5\u770B\u6E90\u7801",title:"Normal",content:"Normals bring objects to life."},H=T({name:"Normal",components:{nano_raytracing_page:V},setup(){const r=E();let t,i,l,e=[.5,.5,1],o=new P(e,e),n=new Y([]),a={circleCenter:[50,50,0],bgCircleCenter:[.5,100.5,10],radius:10,bgColor:[0,0,0],origin:[50,50,100],objectType:0};const g=["Sphere","Box","Cylinder"],u=()=>{t=r.value.getCanvas(),i=r.value.getContext(),i?l=i.createImageData(t.width,t.height):console.log("context not found!"),r.value.addUIItem({type:"select",id:"objectType",default:a.objectType,value:g,callback:v.globalUiCallbacks.updateValue(a,c,"objectType")}),r.value.addUIItem({type:"slider-vector",id:"bgCircleCenter",value:a.bgCircleCenter,min:{0:0,1:0,2:0},max:{0:255,1:255,2:255},callback:v.globalUiCallbacks.updateVector3(a,r.value.Render,"bgCircleCenter")}),r.value.addUIItem({type:"slider-vector",id:"bgColor",value:a.bgColor,min:{0:0,1:0,2:0},max:{0:255,1:255,2:255},callback:v.globalUiCallbacks.updateVector3(a,r.value.Render,"bgColor")}),r.value.addUIItem({type:"slider-vector",id:"circleCenter",value:a.circleCenter,min:{0:0,1:0,2:0},max:{0:100,1:100,2:100},callback:v.globalUiCallbacks.updateVector3(a,r.value.Render,"circleCenter")}),r.value.addUIItem({type:"slider-vector",id:"origin",value:a.origin,min:{0:-500,1:-500,2:-500},max:{0:500,1:500,2:500},callback:v.globalUiCallbacks.updateVector3(a,r.value.Render,"origin")}),r.value.addUIItem({type:"slider",id:"radius",value:a.radius,min:0,max:100,callback:v.globalUiCallbacks.updateVector3(a,r.value.Render,"radius")})},c=()=>{let s=[];A(t);const d=t.width,C=t.height,S=JSON.parse(JSON.stringify(a.bgCircleCenter)),R=JSON.parse(JSON.stringify(a.bgColor)),y=JSON.parse(JSON.stringify(a.origin));Object.keys(y).forEach(p=>{y[p]/=100});const f=JSON.parse(JSON.stringify(a.circleCenter));Object.keys(f).forEach(p=>{f[p]/=100});const x=JSON.parse(JSON.stringify(a.radius))/100,U=d/C;n.clear(),n.add(new O(I(S,h(y,[.5,.5,1])),100)),a.objectType==0?n.add(new O(I(f,h(y,[.5,.5,1])),x)):a.objectType==1?n.add(new Z(f,I(f,[x,x,x]))):a.objectType==2&&n.add(new F(f,x,.2));const D=p=>{let b=new X;return n.hit(p,0,9999,b)?_(I(b.normal,[1,1,1]),.5*255):R},J=1/d,B=1/C;let w=.5/d,k=.5/C;for(let p=0;p<d;p++){w+=J,k=.5/C;for(let b=0;b<C;b++)k+=B,o.setOrigin(y),o.setDirection([U*(w-o.origin[0]),k-o.origin[1],-o.origin[2]]),s=D(o),L(l,p,b,s)}i==null||i.putImageData(l,0,0)};return{desData:G,page:r,Render:c,Init:u}}});function K(r,t,i,l,e,o){const n=q("nano_raytracing_page");return z(),W(n,{prop_des_data:r.desData,onInit:r.Init,onRender:r.Render,ref:"page"},null,8,["prop_des_data","onInit","onRender"])}const it=$(H,[["render",K]]);export{it as default};
