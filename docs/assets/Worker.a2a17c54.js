(function(){"use strict";const _=(i,t,n)=>(n=n||new Float32Array(3),n[0]=i[0]+t[0],n[1]=i[1]+t[1],n[2]=i[2]+t[2],n),u=(i,t)=>[i[0]-t[0],i[1]-t[1],i[2]-t[2]],I=i=>{var t=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);return t>1e-5?[i[0]/t,i[1]/t,i[2]/t]:[0,0,0]},p=(i,t)=>i[0]*t[0]+i[1]*t[1]+i[2]*t[2],b=i=>i[0]*i[0]+i[1]*i[1]+i[2]*i[2],M=(i,t)=>[i[0]*t,i[1]*t,i[2]*t],g=(i,t)=>i!=null&&t!=null?i+(t-i)*Math.random():Math.random(),L=(i,t)=>i&&t?[g(i,t),g(i,t),g(i,t)]:[g(),g(),g()],U=()=>{for(;;){let i=L(-1,1);if(!(Math.pow(i[0]*i[0]+i[1]*i[1]+i[2]*i[2],2)>=1))return i}};class R{constructor(t,n){this.m_origin=t,this.m_direction=n}get origin(){return this.m_origin}get direction(){return this.m_direction}setDirection(t){this.m_direction=t}setOrigin(t){this.m_origin=t}at(t){return _(this.m_origin,M(this.m_direction,t))}}class Z{constructor(t,n,o,e){this.p=t,this.normal=n,this.t=o,this.front_face=e}set_face_normal(t,n){front_face=p(t.direction,n)<0,normal=front_face?n:-n}}class C{hit(t,n,o,e){}}class G extends C{constructor(t){super(),this.objects=t}add(t){this.objects.push(t)}clear(){this.objects=[]}hit(t,n,o,e){let a=!1,r=o;return this.objects.forEach(h=>{h.hit(t,n,r,e)&&(a=!0,r=e.t)}),a}}class S extends C{constructor(t,n){super(),this.center=t,this.radius=n}hit(t,n,o,e){let a=u(t.origin,this.center),r=b(t.direction),h=p(a,t.direction),m=b(a)-this.radius*this.radius,d=h*h-r*m;if(d>0){let c=Math.sqrt(d),s=(-h-c)/r;if(s<o&&s>n)return e.t=s,e.p=t.at(e.t),e.normal=M(u(e.p,this.center),1/this.radius),!0;if(s=(-h+c)/r,s<o&&s>n)return e.t=s,e.p=t.at(e.t),e.normal=M(u(e.p,this.center),1/this.radius),!0}return!1}}class H extends C{constructor(t,n){super(),this.min=t,this.max=n}hit(t,n,o,e){let a,r,h=1/t.direction[0],m=1/t.direction[1],d=1/t.direction[2],c=(this.min[0]-t.origin[0])*h,s=(this.max[0]-t.origin[0])*h;if(a=Math.min(c,s),r=Math.max(c,s),c=(this.min[1]-t.origin[1])*m,s=(this.max[1]-t.origin[1])*m,a=Math.max(a,Math.min(c,s)),r=Math.min(r,Math.max(c,s)),c=(this.min[2]-t.origin[2])*d,s=(this.max[2]-t.origin[2])*d,a=Math.max(a,Math.min(c,s)),r=Math.min(r,Math.max(c,s)),r<a)return!1;if(a>n&&r<o)e.t=a;else if(r>n&&r<o)e.t=r;else return!1;e.p=[t.origin[0]+e.t*t.direction[0],t.origin[1]+e.t*t.direction[1],t.origin[2]+e.t*t.direction[2]];let l=[0,0,0];return e.p[0]<this.min[0]+1e-4?l[0]=-1:e.p[0]>this.max[0]-1e-4&&(l[0]=1),e.p[1]<this.min[1]+1e-4?l[1]=-1:e.p[1]>this.max[1]-1e-4&&(l[1]=1),e.p[2]<this.min[2]+1e-4?l[2]=-1:e.p[2]>this.max[2]-1e-4&&(l[2]=1),e.normal=l,!0}}class J extends C{constructor(t,n,o){super(),this.center=t,this.radius=n,this.height=o}hit(t,n,o,e){const a=u(t.origin,this.center),r=b(t.direction)-Math.pow(p(t.direction,this.axis()),2),h=p(a,t.direction)-p(a,this.axis())*p(t.direction,this.axis()),m=b(a)-Math.pow(p(a,this.axis()),2)-Math.pow(this.radius,2),d=Math.pow(h,2)-r*m;if(d>0){let c=Math.sqrt(d),s=(-h-c)/r;if(s<o&&s>n&&this.isWithinBounds(s,t)){e.t=s,e.p=t.at(e.t);const l=I(u(u(e.p,this.center),M(this.axis(),p(u(e.p,this.center),this.axis()))));return e.normal=l,!0}if(s=(-h+c)/r,s<o&&s>n&&this.isWithinBounds(s,t)){e.t=s,e.p=t.at(e.t);const l=I(u(u(e.p,this.center),M(this.axis(),p(u(e.p,this.center),this.axis()))));return e.normal=l,!0}}return!1}axis(){return[0,1,0]}isWithinBounds(t,n){const o=n.origin[1]+t*n.direction[1];return o>=this.center[1]&&o<=this.center[1]+this.height}}let w=new Z,z,O=new R(origin,origin),j,B,q,A,x=new G([]);const E=(i,t)=>{if(t<=0)return[0,0,0];if(x.hit(i,.001,99999,w))return j=w.p,B=w.normal,q=U(),z=[j[0]+B[0]+q[0],j[1]+B[1]+q[1],j[2]+B[2]+q[2]],O.setOrigin(w.p),O.setDirection(u(z,w.p)),A=E(O,t-1),[A[0]*.5,A[1]*.5,A[2]*.5];{let o=(I(i.direction)[1]+1)*.5;return[255*(1-.5*o),255*(1-.3*o),255]}};self.onmessage=function(i){const{width:t,height:n,max_depth:o,origin:e,bgCircleCenter:a,circleCenter:r,radius:h,samples_per_pixel:m,startX:d,startY:c,endX:s,endY:l}=i.data;let f;const K=1/t,P=1/n,Q=t/n;let N,y=new R(e,e);x.clear(),x.add(new S(_(a,u(e,[.5,.5,1])),100)),x.add(new S(_(r,u(e,[.5,.5,1])),h)),x.add(new H(u(r,[.4,.1,0]),_(r,[h-.3,h,h]))),x.add(new J(_(r,[.3,-.1,0]),h,.2));const D=new Uint8ClampedArray((s-d)*(l-c)*4);for(let W=d;W<s;W++){const T=(W+.5)*K;for(let X=c;X<l;X++){const V=(X+.5)*P;f=[0,0,0];for(let F=0;F<m;F++)y.setDirection([Q*(T-y.origin[0]),V-y.origin[1],-y.origin[2]]),N=E(y,o),f[0]+=N[0],f[1]+=N[1],f[2]+=N[2];const Y=(W-d+(X-c)*(s-d))*4;D[Y+0]=f[0]/m,D[Y+1]=f[1]/m,D[Y+2]=f[2]/m,D[Y+3]=255}}self.postMessage({partImageData:D,startX:d,startY:c,endX:s,endY:l})}})();
