import{d as tt,n as et,r as it,u as y,_ as at,o as st,c as nt,a as rt}from"./index.04f45874.js";import{r as ot,b as lt}from"./RenderUtils.1dc0c613.js";import{v as C,a as R,g,e as u,f as j,b as B,h as ct,i as dt}from"./Vectors.edfcf4f8.js";import{a as ht,r as ut,m as A}from"./Random.16a9fda4.js";class z{constructor(t,i){this.m_origin=t,this.m_direction=i}get origin(){return this.m_origin}get direction(){return this.m_direction}setDirection(t){this.m_direction=t}setOrigin(t){this.m_origin=t}at(t){return C(this.m_origin,R(this.m_direction,t))}}class pt{constructor(t,i,a,e){this.p=t,this.normal=i,this.t=a,this.front_face=e,this.mat_ptr=null}set_face_normal(t,i){front_face=g(t.direction,i)<0,normal=front_face?i:-i}}class X{hit(t,i,a,e){}}class mt extends X{constructor(t){super(),this.objects=t}add(t){this.objects.push(t)}clear(){this.objects=[]}hit(t,i,a,e){let n=!1,r=a;return this.objects.forEach(d=>{d.hit(t,i,r,e)&&(n=!0,r=e.t)}),n}}class H{scatter(t,i){}}class F extends X{constructor(t,i,a){super(),this.center=t,this.radius=i,this.mat_ptr=a}hit(t,i,a,e){let n=u(t.origin,this.center),r=j(t.direction),d=g(n,t.direction),o=j(n)-this.radius*this.radius,m=d*d-r*o;if(m>0){let c=Math.sqrt(m),l=(-d-c)/r;if(l<a&&l>i)return e.t=l,e.p=t.at(e.t),e.normal=R(u(e.p,this.center),1/this.radius),e.mat_ptr=this.mat_ptr,!0;if(l=(-d+c)/r,l<a&&l>i)return e.t=l,e.p=t.at(e.t),e.normal=R(u(e.p,this.center),1/this.radius),e.mat_ptr=this.mat_ptr,!0}return!1}}class _t extends X{constructor(t,i,a){super(),this.min=t,this.max=i,this.mat_ptr=a}hit(t,i,a,e){let n,r,d=1/t.direction[0],o=1/t.direction[1],m=1/t.direction[2],c=(this.min[0]-t.origin[0])*d,l=(this.max[0]-t.origin[0])*d;if(n=Math.min(c,l),r=Math.max(c,l),c=(this.min[1]-t.origin[1])*o,l=(this.max[1]-t.origin[1])*o,n=Math.max(n,Math.min(c,l)),r=Math.min(r,Math.max(c,l)),c=(this.min[2]-t.origin[2])*m,l=(this.max[2]-t.origin[2])*m,n=Math.max(n,Math.min(c,l)),r=Math.min(r,Math.max(c,l)),r<n)return!1;if(n>i&&r<a)e.t=n;else if(r>i&&r<a)e.t=r;else return!1;e.p=[t.origin[0]+e.t*t.direction[0],t.origin[1]+e.t*t.direction[1],t.origin[2]+e.t*t.direction[2]];let p=[0,0,0];return e.p[0]<this.min[0]+1e-4?p[0]=-1:e.p[0]>this.max[0]-1e-4&&(p[0]=1),e.p[1]<this.min[1]+1e-4?p[1]=-1:e.p[1]>this.max[1]-1e-4&&(p[1]=1),e.p[2]<this.min[2]+1e-4?p[2]=-1:e.p[2]>this.max[2]-1e-4&&(p[2]=1),e.normal=p,e.mat_ptr=this.mat_ptr,!0}}class gt extends X{constructor(t,i,a,e){super(),this.center=t,this.radius=i,this.height=a,this.mat_ptr=e}hit(t,i,a,e){const n=u(t.origin,this.center),r=j(t.direction)-Math.pow(g(t.direction,this.axis()),2),d=g(n,t.direction)-g(n,this.axis())*g(t.direction,this.axis()),o=j(n)-Math.pow(g(n,this.axis()),2)-Math.pow(this.radius,2),m=Math.pow(d,2)-r*o;if(m>0){let c=Math.sqrt(m),l=(-d-c)/r;if(l<a&&l>i&&this.isWithinBounds(l,t)){e.t=l,e.p=t.at(e.t);const p=B(u(u(e.p,this.center),R(this.axis(),g(u(e.p,this.center),this.axis()))));return e.normal=p,e.mat_ptr=this.mat_ptr,!0}if(l=(-d+c)/r,l<a&&l>i&&this.isWithinBounds(l,t)){e.t=l,e.p=t.at(e.t);const p=B(u(u(e.p,this.center),R(this.axis(),g(u(e.p,this.center),this.axis()))));return e.normal=p,e.mat_ptr=this.mat_ptr,!0}}return!1}axis(){return[0,1,0]}isWithinBounds(t,i){const a=i.origin[1]+t*i.direction[1];return a>=this.center[1]&&a<=this.center[1]+this.height}}function ft(){return new Worker("/NanoCore-Raytracing/assets/Worker.85225350.js")}class G extends H{constructor(t){super(),this.albedo=t}scatter(t,i){let a=C(i.normal,ht());const e=new z(i.p,a),n=this.albedo;return{scatter:!0,scattered:e,attenuation:n}}}class Z extends H{constructor(t,i){super(),this.albedo=t,this.fuzz=i<1?i:1}scatter(t,i){const a=ct(B(t.direction),i.normal),e=new z(i.p,C(a,R(ut(),this.fuzz))),n=this.albedo;return{scatter:g(e.direction,i.normal)>0,scattered:e,attenuation:n}}}const bt={category:"MentalMT",name:"MentalMT",buttonContent:"\u67E5\u770B\u6E90\u7801",title:"MentalMT",content:"Metal makes the world shiny."},xt=tt({name:"MentalMT",components:{nano_raytracing_page:et},setup(){const s=it();let t,i,a,e=[.5,.5,1],n=new z(e,e),r=new mt([]),d,o={circleCenter:[50,50,0],bgCircleCenter:[.5,99,-18],radius:10,origin:[50,50,100],samples_per_pixel:1,max_depth:20,use_worker:!1};const m=4,c=[];for(let f=0;f<m;f++){const b=new ft;c.push(b)}return{desData:bt,page:s,Render:()=>{let f=[0,0,0];ot(t);const b=t.width,I=t.height,E=JSON.parse(JSON.stringify(o.bgCircleCenter)),M=JSON.parse(JSON.stringify(o.circleCenter));Object.keys(M).forEach(h=>{M[h]/=100});const D=JSON.parse(JSON.stringify(o.origin));Object.keys(D).forEach(h=>{D[h]/=100});const N=JSON.parse(JSON.stringify(o.radius))/100,Y=JSON.parse(JSON.stringify(o.samples_per_pixel)),$=JSON.parse(JSON.stringify(o.max_depth)),K=b/I;r.clear(),r.add(new F(C(E,u([.5,.5,1],[.5,.5,1])),100,new G([.8,.8,0]))),r.add(new F(C(M,u([.5,.5,1],[.5,.5,1])),N,new G([.7,.3,.3]))),r.add(new _t(u(M,[.4,.1,0]),C(M,[N-.3,N,N]),new Z([.8,.8,.8],1))),r.add(new gt(C(M,[.3,-.1,0]),N,.2,new Z([.8,.6,.2],1)));let T=new pt;const L=(h,k)=>{if(k<=0)return[0,0,0];if(r.hit(h,.001,99999,T)){const{scatter:x,scattered:_,attenuation:v}=T.mat_ptr.scatter(h,T);return x?dt(v,L(_,k-1)):[0,0,0]}else{let _=(B(h.direction)[1]+1)*.5;return[255*(1-.5*_),255*(1-.3*_),255]}};if(n.setOrigin(D),o.use_worker){d=Date.now();for(let h=0;h<m;h++){c[h].onmessage=function(S){const{partImageData:w,startX:O,startY:q,endX:P,endY:Q}=S.data;for(let U=O;U<P;U++)for(let J=q;J<Q;J++){const W=(J*b+U)*4,V=((J-q)*(P-O)+U-O)*4;a.data[W]=w[V],a.data[W+1]=w[V+1],a.data[W+2]=w[V+2],a.data[W+3]=w[V+3]}i==null||i.putImageData(a,0,0),s.value.debugLog("Worker FPS",1e3/(Date.now()-d))};const k=Math.floor(h%2*(t.width/2)),x=Math.floor((h<2?0:1)*(t.height/2)),_=Math.floor(k+t.width/2),v=Math.floor(x+t.height/2);c[h].postMessage({width:b,height:I,max_depth:$,origin:D,bgCircleCenter:E,circleCenter:M,radius:N,samples_per_pixel:Y,startX:k,startY:x,endX:_,endY:v})}}else{const h=1/b,k=1/I;let x=.5/b,_=.5/I,v;for(let S=0;S<b;S++){x+=h,_=.5/I;for(let w=0;w<I;w++){_+=k,f=[0,0,0];for(let O=0;O<Y;O++)n.setDirection([K*(x-n.origin[0]+A(0,.001)),_-n.origin[1]+A(0,.001),-n.origin[2]]),v=L(n,$),f[0]+=v[0],f[1]+=v[1],f[2]+=v[2],lt(a,S,w,f,Y)}}}i==null||i.putImageData(a,0,0)},Init:()=>{t=s.value.getCanvas(),i=s.value.getContext(),i?a=i.createImageData(t.width,t.height):console.log("context not found!"),s.value.addUIItem({type:"slider-vector",id:"bgCircleCenter",value:o.bgCircleCenter,min:{0:0,1:0,2:0},max:{0:255,1:255,2:255},callback:y.globalUiCallbacks.updateVector3(o,s.value.Render,"bgCircleCenter")}),s.value.addUIItem({type:"slider-vector",id:"circleCenter",value:o.circleCenter,min:{0:0,1:0,2:0},max:{0:100,1:100,2:100},callback:y.globalUiCallbacks.updateVector3(o,s.value.Render,"circleCenter")}),s.value.addUIItem({type:"slider-vector",id:"origin",value:o.origin,min:{0:-500,1:-500,2:-500},max:{0:500,1:500,2:500},callback:y.globalUiCallbacks.updateVector3(o,s.value.Render,"origin")}),s.value.addUIItem({type:"slider",id:"radius",value:o.radius,min:0,max:100,callback:y.globalUiCallbacks.updateVector3(o,s.value.Render,"radius")}),s.value.addUIItem({type:"slider",id:"samples_per_pixel",value:o.samples_per_pixel,min:1,max:100,callback:y.globalUiCallbacks.updateVector3(o,s.value.Render,"samples_per_pixel")}),s.value.addUIItem({type:"slider",id:"max_depth",value:o.max_depth,min:1,max:100,callback:y.globalUiCallbacks.updateVector3(o,s.value.Render,"max_depth")}),s.value.addUIItem({type:"checkbox",id:"use_worker",value:o.use_worker,default:!1,callback:y.globalUiCallbacks.updateValue(o,s.value.Render,"use_worker")})}}}});function vt(s,t,i,a,e,n){const r=rt("nano_raytracing_page");return st(),nt(r,{prop_des_data:s.desData,onInit:s.Init,onRender:s.Render,ref:"page"},null,8,["prop_des_data","onInit","onRender"])}const Ct=at(xt,[["render",vt]]);export{Ct as default};
