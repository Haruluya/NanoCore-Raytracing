import{d as et,n as it,r as at,u as k,_ as st,o as nt,c as rt,a as ot}from"./index.04f45874.js";import{r as lt,b as ct}from"./RenderUtils.1dc0c613.js";import{v as y,a as I,g as _,e as p,f as B,b as S,h as K,j as dt,i as ht}from"./Vectors.edfcf4f8.js";import{a as ut,r as pt,m as F}from"./Random.16a9fda4.js";class X{constructor(t,i){this.m_origin=t,this.m_direction=i}get origin(){return this.m_origin}get direction(){return this.m_direction}setDirection(t){this.m_direction=t}setOrigin(t){this.m_origin=t}at(t){return y(this.m_origin,I(this.m_direction,t))}}class mt{constructor(t,i,a,e){this.p=t,this.normal=i,this.t=a,this.front_face=e,this.mat_ptr=null}set_face_normal(t,i){front_face=_(t.direction,i)<0,normal=front_face?i:-i}}class Y{hit(t,i,a,e){}}class _t extends Y{constructor(t){super(),this.objects=t}add(t){this.objects.push(t)}clear(){this.objects=[]}hit(t,i,a,e){let s=!1,n=a;return this.objects.forEach(d=>{d.hit(t,i,n,e)&&(s=!0,n=e.t)}),s}}class E{scatter(t,i){}}class Z extends Y{constructor(t,i,a){super(),this.center=t,this.radius=i,this.mat_ptr=a}hit(t,i,a,e){let s=p(t.origin,this.center),n=B(t.direction),d=_(s,t.direction),o=B(s)-this.radius*this.radius,u=d*d-n*o;if(u>0){let c=Math.sqrt(u),l=(-d-c)/n;if(l<a&&l>i)return e.t=l,e.p=t.at(e.t),e.normal=I(p(e.p,this.center),1/this.radius),e.mat_ptr=this.mat_ptr,!0;if(l=(-d+c)/n,l<a&&l>i)return e.t=l,e.p=t.at(e.t),e.normal=I(p(e.p,this.center),1/this.radius),e.mat_ptr=this.mat_ptr,!0}return!1}}class ft extends Y{constructor(t,i,a){super(),this.min=t,this.max=i,this.mat_ptr=a}hit(t,i,a,e){let s,n,d=1/t.direction[0],o=1/t.direction[1],u=1/t.direction[2],c=(this.min[0]-t.origin[0])*d,l=(this.max[0]-t.origin[0])*d;if(s=Math.min(c,l),n=Math.max(c,l),c=(this.min[1]-t.origin[1])*o,l=(this.max[1]-t.origin[1])*o,s=Math.max(s,Math.min(c,l)),n=Math.min(n,Math.max(c,l)),c=(this.min[2]-t.origin[2])*u,l=(this.max[2]-t.origin[2])*u,s=Math.max(s,Math.min(c,l)),n=Math.min(n,Math.max(c,l)),n<s)return!1;if(s>i&&n<a)e.t=s;else if(n>i&&n<a)e.t=n;else return!1;e.p=[t.origin[0]+e.t*t.direction[0],t.origin[1]+e.t*t.direction[1],t.origin[2]+e.t*t.direction[2]];let m=[0,0,0];return e.p[0]<this.min[0]+1e-4?m[0]=-1:e.p[0]>this.max[0]-1e-4&&(m[0]=1),e.p[1]<this.min[1]+1e-4?m[1]=-1:e.p[1]>this.max[1]-1e-4&&(m[1]=1),e.p[2]<this.min[2]+1e-4?m[2]=-1:e.p[2]>this.max[2]-1e-4&&(m[2]=1),e.normal=m,e.mat_ptr=this.mat_ptr,!0}}class gt extends Y{constructor(t,i,a,e){super(),this.center=t,this.radius=i,this.height=a,this.mat_ptr=e}hit(t,i,a,e){const s=p(t.origin,this.center),n=B(t.direction)-Math.pow(_(t.direction,this.axis()),2),d=_(s,t.direction)-_(s,this.axis())*_(t.direction,this.axis()),o=B(s)-Math.pow(_(s,this.axis()),2)-Math.pow(this.radius,2),u=Math.pow(d,2)-n*o;if(u>0){let c=Math.sqrt(u),l=(-d-c)/n;if(l<a&&l>i&&this.isWithinBounds(l,t)){e.t=l,e.p=t.at(e.t);const m=S(p(p(e.p,this.center),I(this.axis(),_(p(e.p,this.center),this.axis()))));return e.normal=m,e.mat_ptr=this.mat_ptr,!0}if(l=(-d+c)/n,l<a&&l>i&&this.isWithinBounds(l,t)){e.t=l,e.p=t.at(e.t);const m=S(p(p(e.p,this.center),I(this.axis(),_(p(e.p,this.center),this.axis()))));return e.normal=m,e.mat_ptr=this.mat_ptr,!0}}return!1}axis(){return[0,1,0]}isWithinBounds(t,i){const a=i.origin[1]+t*i.direction[1];return a>=this.center[1]&&a<=this.center[1]+this.height}}function bt(){return new Worker("/NanoCore-Raytracing/assets/Worker.913f2718.js")}class H extends E{constructor(t){super(),this.albedo=t}scatter(t,i){let a=y(i.normal,ut());const e=new X(i.p,a),s=this.albedo;return{scatter:!0,scattered:e,attenuation:s}}}class xt extends E{constructor(t,i){super(),this.albedo=t,this.fuzz=i<1?i:1}scatter(t,i){const a=K(S(t.direction),i.normal),e=new X(i.p,y(a,I(pt(),this.fuzz))),s=this.albedo;return{scatter:_(e.direction,i.normal)>0,scattered:e,attenuation:s}}}class $ extends E{constructor(t){super(),this.m_ir=t}scatter(t,i){let a=[1,1,1],e=i.front_face?1/this.m_ir:this.m_ir,s=S(t.direction),n=Math.min(_(I(s,-1),i.normal),1),d=Math.sqrt(1-n*n),o=e*d>1,u;return o||$.reflectance(n,e)?u=K(s,i.normal):u=dt(s,i.normal,e),{scatter:!0,scattered:new X(i.p,u),attenuation:a}}static reflectance(t,i){let a=(1-i)/(1+i);return a=a*a,a+(1-a)*Math.pow(1-t,5)}}const vt={category:"DielectricsMT",name:"DielectricsMT",buttonContent:"\u67E5\u770B\u6E90\u7801",title:"DielectricsMT",content:"Glass needs dielectrics"},wt=et({name:"DielectricsMT",components:{nano_raytracing_page:it},setup(){const r=at();let t,i,a,e=[.5,.5,1],s=new X(e,e),n=new _t([]),d,o={circleCenter:[50,50,0],bgCircleCenter:[.5,99,-18],radius:10,origin:[50,50,100],samples_per_pixel:1,max_depth:20,use_worker:!1};const u=4,c=[];for(let g=0;g<u;g++){const b=new bt;c.push(b)}return{desData:vt,page:r,Render:()=>{let g=[0,0,0];lt(t);const b=t.width,D=t.height,q=JSON.parse(JSON.stringify(o.bgCircleCenter)),M=JSON.parse(JSON.stringify(o.circleCenter));Object.keys(M).forEach(h=>{M[h]/=100});const U=JSON.parse(JSON.stringify(o.origin));Object.keys(U).forEach(h=>{U[h]/=100});const R=JSON.parse(JSON.stringify(o.radius))/100,T=JSON.parse(JSON.stringify(o.samples_per_pixel)),L=JSON.parse(JSON.stringify(o.max_depth)),Q=b/D;n.clear(),n.add(new Z(y(q,p([.5,.5,1],[.5,.5,1])),100,new H([.8,.8,0]))),n.add(new Z(y(M,p([.5,.5,1],[.5,.5,1])),R+.05,new $(1.5))),n.add(new ft(p(M,[.4,.1,0]),y(M,[R-.3,R,R]),new H([.8,.8,.8]))),n.add(new gt(y(M,[.3,-.1,0]),R,.2,new xt([.8,.6,.2],1)));let z=new mt;const G=(h,C)=>{if(C<=0)return[0,0,0];if(n.hit(h,.001,99999,z)){const{scatter:x,scattered:f,attenuation:v}=z.mat_ptr.scatter(h,z);return x?ht(v,G(f,C-1)):[0,0,0]}else{let f=(S(h.direction)[1]+1)*.5;return[255*(1-.5*f),255*(1-.3*f),255]}};if(s.setOrigin(U),o.use_worker){d=Date.now();for(let h=0;h<u;h++){c[h].onmessage=function(O){const{partImageData:w,startX:N,startY:P,endX:A,endY:tt}=O.data;for(let J=N;J<A;J++)for(let W=P;W<tt;W++){const j=(W*b+J)*4,V=((W-P)*(A-N)+J-N)*4;a.data[j]=w[V],a.data[j+1]=w[V+1],a.data[j+2]=w[V+2],a.data[j+3]=w[V+3]}i==null||i.putImageData(a,0,0),r.value.debugLog("Worker FPS",1e3/(Date.now()-d))};const C=Math.floor(h%2*(t.width/2)),x=Math.floor((h<2?0:1)*(t.height/2)),f=Math.floor(C+t.width/2),v=Math.floor(x+t.height/2);c[h].postMessage({width:b,height:D,max_depth:L,origin:U,bgCircleCenter:q,circleCenter:M,radius:R,samples_per_pixel:T,startX:C,startY:x,endX:f,endY:v})}}else{const h=1/b,C=1/D;let x=.5/b,f=.5/D,v;for(let O=0;O<b;O++){x+=h,f=.5/D;for(let w=0;w<D;w++){f+=C,g=[0,0,0];for(let N=0;N<T;N++)s.setDirection([Q*(x-s.origin[0]+F(0,.001)),f-s.origin[1]+F(0,.001),-s.origin[2]]),v=G(s,L),g[0]+=v[0],g[1]+=v[1],g[2]+=v[2],ct(a,O,w,g,T)}}}i==null||i.putImageData(a,0,0)},Init:()=>{t=r.value.getCanvas(),i=r.value.getContext(),i?a=i.createImageData(t.width,t.height):console.log("context not found!"),r.value.addUIItem({type:"slider-vector",id:"bgCircleCenter",value:o.bgCircleCenter,min:{0:0,1:0,2:0},max:{0:255,1:255,2:255},callback:k.globalUiCallbacks.updateVector3(o,r.value.Render,"bgCircleCenter")}),r.value.addUIItem({type:"slider-vector",id:"origin",value:o.origin,min:{0:-500,1:-500,2:-500},max:{0:500,1:500,2:500},callback:k.globalUiCallbacks.updateVector3(o,r.value.Render,"origin")}),r.value.addUIItem({type:"slider-vector",id:"circleCenter",value:o.circleCenter,min:{0:0,1:0,2:0},max:{0:100,1:100,2:100},callback:k.globalUiCallbacks.updateVector3(o,r.value.Render,"circleCenter")}),r.value.addUIItem({type:"slider",id:"radius",value:o.radius,min:0,max:100,callback:k.globalUiCallbacks.updateVector3(o,r.value.Render,"radius")}),r.value.addUIItem({type:"slider",id:"samples_per_pixel",value:o.samples_per_pixel,min:1,max:100,callback:k.globalUiCallbacks.updateVector3(o,r.value.Render,"samples_per_pixel")}),r.value.addUIItem({type:"slider",id:"max_depth",value:o.max_depth,min:1,max:100,callback:k.globalUiCallbacks.updateVector3(o,r.value.Render,"max_depth")}),r.value.addUIItem({type:"checkbox",id:"use_worker",value:o.use_worker,default:!1,callback:k.globalUiCallbacks.updateValue(o,r.value.Render,"use_worker")})}}}});function Mt(r,t,i,a,e,s){const n=ot("nano_raytracing_page");return nt(),rt(n,{prop_des_data:r.desData,onInit:r.Init,onRender:r.Render,ref:"page"},null,8,["prop_des_data","onInit","onRender"])}const Dt=st(wt,[["render",Mt]]);export{Dt as default};
