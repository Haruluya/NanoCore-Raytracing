import{d as W,n as q,r as L,u as f,_ as P,o as X,c as Y,a as Z}from"./index.c9ddb6cf.js";import{r as F,a as G}from"./RenderUtils.1dc0c613.js";import{v as w,a as x,g as m,e as h,f as M,b as R}from"./Vectors.edfcf4f8.js";import{m as B}from"./Random.16a9fda4.js";class H{constructor(t,a){this.m_origin=t,this.m_direction=a}get origin(){return this.m_origin}get direction(){return this.m_direction}setDirection(t){this.m_direction=t}setOrigin(t){this.m_origin=t}at(t){return w(this.m_origin,x(this.m_direction,t))}}class K{constructor(t,a,l,e){this.p=t,this.normal=a,this.t=l,this.front_face=e}set_face_normal(t,a){front_face=m(t.direction,a)<0,normal=front_face?a:-a}}class N{hit(t,a,l,e){}}class Q extends N{constructor(t){super(),this.objects=t}add(t){this.objects.push(t)}clear(){this.objects=[]}hit(t,a,l,e){let s=!1,r=l;return this.objects.forEach(i=>{i.hit(t,a,r,e)&&(s=!0,r=e.t)}),s}}class T extends N{constructor(t,a){super(),this.center=t,this.radius=a}hit(t,a,l,e){let s=h(t.origin,this.center),r=M(t.direction),i=m(s,t.direction),g=M(s)-this.radius*this.radius,p=i*i-r*g;if(p>0){let c=Math.sqrt(p),n=(-i-c)/r;if(n<l&&n>a)return e.t=n,e.p=t.at(e.t),e.normal=x(h(e.p,this.center),1/this.radius),!0;if(n=(-i+c)/r,n<l&&n>a)return e.t=n,e.p=t.at(e.t),e.normal=x(h(e.p,this.center),1/this.radius),!0}return!1}}class tt extends N{constructor(t,a){super(),this.min=t,this.max=a}hit(t,a,l,e){let s,r,i=1/t.direction[0],g=1/t.direction[1],p=1/t.direction[2],c=(this.min[0]-t.origin[0])*i,n=(this.max[0]-t.origin[0])*i;if(s=Math.min(c,n),r=Math.max(c,n),c=(this.min[1]-t.origin[1])*g,n=(this.max[1]-t.origin[1])*g,s=Math.max(s,Math.min(c,n)),r=Math.min(r,Math.max(c,n)),c=(this.min[2]-t.origin[2])*p,n=(this.max[2]-t.origin[2])*p,s=Math.max(s,Math.min(c,n)),r=Math.min(r,Math.max(c,n)),r<s)return!1;if(s>a&&r<l)e.t=s;else if(r>a&&r<l)e.t=r;else return!1;e.p=[t.origin[0]+e.t*t.direction[0],t.origin[1]+e.t*t.direction[1],t.origin[2]+e.t*t.direction[2]];let d=[0,0,0];return e.p[0]<this.min[0]+1e-4?d[0]=-1:e.p[0]>this.max[0]-1e-4&&(d[0]=1),e.p[1]<this.min[1]+1e-4?d[1]=-1:e.p[1]>this.max[1]-1e-4&&(d[1]=1),e.p[2]<this.min[2]+1e-4?d[2]=-1:e.p[2]>this.max[2]-1e-4&&(d[2]=1),e.normal=d,!0}}class et extends N{constructor(t,a,l){super(),this.center=t,this.radius=a,this.height=l}hit(t,a,l,e){const s=h(t.origin,this.center),r=M(t.direction)-Math.pow(m(t.direction,this.axis()),2),i=m(s,t.direction)-m(s,this.axis())*m(t.direction,this.axis()),g=M(s)-Math.pow(m(s,this.axis()),2)-Math.pow(this.radius,2),p=Math.pow(i,2)-r*g;if(p>0){let c=Math.sqrt(p),n=(-i-c)/r;if(n<l&&n>a&&this.isWithinBounds(n,t)){e.t=n,e.p=t.at(e.t);const d=R(h(h(e.p,this.center),x(this.axis(),m(h(e.p,this.center),this.axis()))));return e.normal=d,!0}if(n=(-i+c)/r,n<l&&n>a&&this.isWithinBounds(n,t)){e.t=n,e.p=t.at(e.t);const d=R(h(h(e.p,this.center),x(this.axis(),m(h(e.p,this.center),this.axis()))));return e.normal=d,!0}}return!1}axis(){return[0,1,0]}isWithinBounds(t,a){const l=a.origin[1]+t*a.direction[1];return l>=this.center[1]&&l<=this.center[1]+this.height}}const it={category:"Antialiasing",name:"Antialiasing",buttonContent:"\u67E5\u770B\u6E90\u7801",title:"Antialiasing",content:"Antialiasing."},at=W({name:"Normal",components:{nano_raytracing_page:q},setup(){const o=L();let t,a,l,e=[.5,.5,1],s=new H(e,e),r=new Q([]),i={circleCenter:[10,50,0],bgCircleCenter:[.5,100.5,10],radius:50,bgColor:[0,0,0],origin:[50,50,100],samples_per_pixel:1,objectType:0};const g=["Sphere","Box","Cylinder"],p=()=>{t=o.value.getCanvas(),a=o.value.getContext(),a?l=a.createImageData(t.width,t.height):console.log("context not found!"),o.value.addUIItem({type:"select",id:"objectType",default:i.objectType,value:g,callback:f.globalUiCallbacks.updateValue(i,c,"objectType")}),o.value.addUIItem({type:"slider-vector",id:"bgCircleCenter",value:i.bgCircleCenter,min:{0:0,1:0,2:0},max:{0:255,1:255,2:255},callback:f.globalUiCallbacks.updateVector3(i,o.value.Render,"bgCircleCenter")}),o.value.addUIItem({type:"slider-vector",id:"bgColor",value:i.bgColor,min:{0:0,1:0,2:0},max:{0:255,1:255,2:255},callback:f.globalUiCallbacks.updateVector3(i,o.value.Render,"bgColor")}),o.value.addUIItem({type:"slider-vector",id:"origin",value:i.origin,min:{0:-500,1:-500,2:-500},max:{0:500,1:500,2:500},callback:f.globalUiCallbacks.updateVector3(i,o.value.Render,"origin")}),o.value.addUIItem({type:"slider-vector",id:"circleCenter",value:i.circleCenter,min:{0:0,1:0,2:0},max:{0:100,1:100,2:100},callback:f.globalUiCallbacks.updateVector3(i,o.value.Render,"circleCenter")}),o.value.addUIItem({type:"slider",id:"radius",value:i.radius,min:0,max:100,callback:f.globalUiCallbacks.updateVector3(i,o.value.Render,"radius")}),o.value.addUIItem({type:"slider",id:"samples_per_pixel",value:i.samples_per_pixel,min:1,max:20,callback:f.globalUiCallbacks.updateVector3(i,o.value.Render,"samples_per_pixel")})},c=()=>{let n=[0,0,0];F(t);const d=t.width,_=t.height,V=JSON.parse(JSON.stringify(i.bgCircleCenter)),A=JSON.parse(JSON.stringify(i.bgColor)),b=JSON.parse(JSON.stringify(i.circleCenter)),C=JSON.parse(JSON.stringify(i.origin));Object.keys(C).forEach(u=>{C[u]/=100}),Object.keys(b).forEach(u=>{b[u]/=100});const v=JSON.parse(JSON.stringify(i.radius))/100,S=JSON.parse(JSON.stringify(i.samples_per_pixel)),U=d/_;r.clear(),r.add(new T(w(V,h(C,[.5,.5,1])),100)),i.objectType==0?r.add(new T(w(b,h(C,[.5,.5,1])),v)):i.objectType==1?r.add(new tt(b,w(b,[v,v,v]))):i.objectType==2&&r.add(new et(b,v,.2));let D=new K,y;const E=u=>r.hit(u,0,9999,D)?(y=D.normal,[(y[0]+1)*128,(y[1]+1)*128,(y[2]+1)*128]):A,$=1/d,z=1/_;let O=.5/d,I=.5/_,k;for(let u=0;u<d;u++){O+=$,I=.5/_;for(let j=0;j<_;j++){I+=z,n=[0,0,0];for(let J=0;J<S;J++)S==1?s.setDirection([U*(O-s.origin[0]),I-s.origin[1],-s.origin[2]]):s.setDirection([U*(O-s.origin[0]+B(0,.001)),I-s.origin[1]+B(0,.001),-s.origin[2]]),k=E(s),n[0]+=k[0],n[1]+=k[1],n[2]+=k[2],G(l,u,j,n,S)}}a==null||a.putImageData(l,0,0)};return{desData:it,page:o,Render:c,Init:p}}});function nt(o,t,a,l,e,s){const r=Z("nano_raytracing_page");return X(),Y(r,{prop_des_data:o.desData,onInit:o.Init,onRender:o.Render,ref:"page"},null,8,["prop_des_data","onInit","onRender"])}const ct=P(at,[["render",nt]]);export{ct as default};
